# Документация на проект: MongoDB База данни за магазин за авточасти

## I. Общо описание на проекта

Проектът представлява MongoDB база данни за управление на магазин за авточасти. Базата данни е реализирана с помощта на MongoDB и Node.js и демонстрира правилното структуриране на данни, изпълнение на различни видове заявки и управление на достъпа.

## II. Структура на базата данни

### 1. Колекции

Базата данни се състои от следните колекции:

#### a) `parts` - Колекция с авточасти

Съдържа информация за всички авточасти в магазина, включително:

- `partNumber` - уникален идентификатор на частта
- `name` - име на частта
- `category` - категория (филтри, спирачна система, двигател и др.)
- `manufacturer` - производител
- `price` - цена
- `compatibleCars` - масив с марки автомобили, за които е съвместима частта
- `stockQuantity` - количество в склада
- `location` - местоположение в склада
- `specifications` - технически спецификации (обект с различни характеристики)

#### б) `customers` - Колекция с клиенти

Съдържа информация за клиентите на магазина, включително:

- `customerId` - уникален идентификатор на клиента
- `firstName`, `lastName` / `companyName` - имена на физическо лице или име на фирма
- `email` - имейл адрес
- `phone` - телефонен номер
- `address` - адрес (обект с улица, град, пощенски код, държава)
- `registrationDate` - дата на регистрация
- `loyaltyPoints` - точки за лоялност
- `customerType` - тип на клиента (retail или wholesale)
- `carDetails` - информация за автомобилите на клиента (само за retail клиенти)
- `vatNumber` - ДДС номер (само за wholesale клиенти)

#### в) `orders` - Колекция с поръчки

Съдържа информация за поръчките, направени от клиентите:

- `orderId` - уникален идентификатор на поръчката
- `customerId` - идентификатор на клиента, направил поръчката
- `orderDate` - дата и час на поръчката
- `status` - състояние на поръчката (Processing, Shipped, Completed)
- `items` - масив с поръчаните артикули (всеки с номер на част, количество, цена, отстъпка)
- `shipping` - информация за доставката (метод, цена, проследяващ номер, очаквана дата)
- `payment` - информация за плащането (метод, номер на транзакция, сума, статус)
- `notes` - бележки към поръчката

#### г) `roles` - Колекция с роли за управление на достъпа

Служебна колекция за съхранение на роли и права за достъп:

- `name` - име на ролята
- `description` - описание на ролята
- `permissions` - права за достъп до различните колекции

### 2. Индекси

За оптимизиране на работата с базата данни са създадени следните индекси:

#### a) Индекси за колекцията `parts`:

- `partNumber`: уникален индекс
- `category`
- `manufacturer`
- `compatibleCars`

#### б) Индекси за колекцията `customers`:

- `customerId`: уникален индекс
- `email`: уникален индекс
- `customerType`
- `address.city`

#### в) Индекси за колекцията `orders`:

- `orderId`: уникален индекс
- `customerId`
- `orderDate`
- `status`
- `items.partNumber`

## III. Реализирани операции над базата данни

### 1. Основни CRUD операции

#### a) Създаване (Create)

- Добавяне на нова авточаст
- Добавяне на нов клиент
- Създаване на нова поръчка

#### б) Четене (Read)

- Намиране на част по номер (точно съвпадение)
- Намиране на части по категория и цена над определена стойност
- Търсене на части, съвместими с определена марка автомобил
- Търсене с регулярен израз за име на част
- Сортиране на части по цена

#### в) Актуализиране (Update)

- Актуализиране на цена на една част
- Увеличаване на лоялни точки на клиент
- Актуализиране на състояние на поръчка и добавяне на проследяващ номер
- Актуализиране на всички части от определен производител с увеличение на цената
- Добавяне на съвместим автомобил към съществуваща част

#### г) Изтриване (Delete)

- Изтриване на една част
- Изтриване на няколко части с нулево количество
- Изтриване на поръчка
- Изтриване на клиент

### 2. Сложни заявки с агрегация

#### a) Най-продавани части

Заявка за определяне на най-продаваните авточасти, включваща: разгъване на масиви, групиране, сортиране, свързване на колекции и проекция.

#### б) Анализ на продажбите по месеци и категории

Заявка за анализ на продажбите по месеци и категории части, включваща: разгъване на масиви, свързване на колекции, форматиране на дати, групиране и сортиране.

#### в) Обобщение на клиенти по градове

Заявка за обобщение на клиентите по градове, включваща: групиране, изчисляване на средни стойности, условни агрегации и сортиране.

#### г) Най-активни клиенти с поръчки

Заявка за определяне на най-активните клиенти, включваща: свързване на колекции, изчисляване на общи суми, филтриране, сортиране и проекция.

#### д) Анализ на най-печеливши категории части

Заявка за определяне на най-печелившите категории части, включваща: групиране, изчисляване на средни цени, общи стойности и сортиране.

### 3. Контрол на достъпа (RBAC)

#### a) Дефиниране на роли

- `admin` - Администратор с пълен достъп до всички колекции
- `manager` - Мениджър, който може да чете всичко и да редактира части и поръчки
- `sales` - Търговец, който може да чете всичко и да редактира клиенти и поръчки
- `inventory` - Отговорник за склада, който управлява само наличностите
- `readonly` - Потребител само с права за четене

#### б) Симулиране на достъп според ролите

Демонстрация на различни операции с потребители с различни роли и проверка на правата им за достъп.

#### в) Ограничения на ниво документи (Row-Level Security)

Демонстрация на ограничения за достъп на ниво документи, например търговец да вижда само поръчките, които е обработил.

## IV. Технологии и инструменти

1. **MongoDB** - NoSQL база данни, използвана за съхранение на данните
2. **Node.js** - JavaScript среда за изпълнение на сървърен код
3. **MongoDB Atlas** - Облачна услуга за хостване на MongoDB бази данни
4. **MongoDB Driver for Node.js** - Официален драйвер за работа с MongoDB от Node.js

## V. Инструкции за инсталация и настройка

### 1. Изисквания преди инсталацията

За успешното стартиране на проекта се изискват:

- Node.js (версия 14.x или по-нова)
- npm (включен в Node.js)
- Акаунт в MongoDB Atlas (безплатен план е достатъчен)
- Git за клониране на репозиторията

### 2. Клониране на репозиторията

Отворете терминал и изпълнете следната команда:

```bash
git clone <URL на репозиторията>
cd <име-на-директорията>
```

### 3. Инсталиране на зависимостите

В директорията на проекта изпълнете:

```bash
npm install
```

Това ще инстализира всички необходими пакети, описани в `package.json`.

### 4. Настройка на MongoDB Atlas

#### 4.1. Създаване на клъстер в MongoDB Atlas

1. Регистрирайте се или влезте в акаунта си в [MongoDB Atlas](https://www.mongodb.com/cloud/atlas).
2. Създайте нов проект (ако нямате).
3. В проекта, създайте нов клъстер ("Build a Cluster").
4. Изберете безплатния план (Shared) и подходящ доставчик (AWS, Google Cloud или Azure).
5. Изберете регион близо до вас за по-добра производителност.
6. Оставете настройките по подразбиране и натиснете "Create Cluster".
7. Изчакайте клъстерът да се създаде (отнема няколко минути).

#### 4.2. Настройка на потребител за достъп до базата данни

1. В секция "Database Access" (от лявото меню) натиснете "Add New Database User".
2. Изберете метод за аутентикация "Password".
3. Въведете потребителско име и сигурна парола (без специални символи, за да избегнете проблеми с URI връзката).
4. Задайте "Database User Privileges" на "Read and Write to Any Database".
5. Натиснете "Add User".

#### 4.3. Настройка на мрежовия достъп

1. В секция "Network Access" (от лявото меню) натиснете "Add IP Address".
2. За разработка, можете да добавите текущия си IP адрес или да разрешите достъп от всякъде (0.0.0.0/0) (само за разработка, не за производство).
3. Натиснете "Confirm".

#### 4.4. Получаване на връзката към MongoDB

1. В главната страница на клъстера, натиснете "Connect".
2. Изберете "Connect your application".
3. Копирайте връзката за свързване (Connection String).
4. Заменете `<password>` с паролата на създадения потребител.

### 5. Конфигуриране на локална среда

1. В основната директория на проекта, създайте файл с име `.env`.
2. Отворете файла и добавете следните редове:

```
MONGODB_URI=<вашата-connection-string-от-стъпка-4.4>
DB_NAME=autoparts
```

Пример:

```
MONGODB_URI=mongodb+srv://username:password@cluster0.abc123.mongodb.net/autoparts?retryWrites=true&w=majority
DB_NAME=autoparts
```

### 6. Стартиране на проекта

Проектът съдържа няколко скрипта, които можете да изпълните последователно, за да инициализирате и тествате базата данни:

#### 6.1. Инициализиране на базата данни

```bash
npm run setup
```

Този скрипт:

- Създава необходимите колекции (parts, customers, orders, roles)
- Добавя примерни данни към колекциите
- Създава индекси за оптимизация на заявките

#### 6.2. Демонстрация на CRUD операции

```bash
npm run crud
```

Този скрипт демонстрира основните операции:

- Създаване на записи
- Четене на данни с филтри и сортиране
- Актуализиране на записи
- Изтриване на данни

#### 6.3. Изпълнение на сложни заявки

```bash
npm run queries
```

Този скрипт демонстрира сложни агрегационни заявки:

- Най-продавани части
- Анализ на продажбите по месеци и категории
- Обобщение на клиенти по градове
- Най-активни клиенти с поръчки
- Анализ на най-печеливши категории части

#### 6.4. Демонстрация на контрол на достъпа

```bash
npm run access
```

Този скрипт демонстрира:

- Различни роли и права за достъп
- Симулация на операции с различни потребителски роли
- Ограничения на достъпа на ниво документи

### 7. Проверка на резултата

След изпълнение на скриптовете, можете да проверите резултата в:

1. **Конзолата**: Всеки скрипт отпечатва резултатите от операциите.
2. **MongoDB Atlas**: Можете да видите създадените колекции и данни в интерфейса на MongoDB Atlas.
   - Отворете вашия клъстер
   - Натиснете "Collections"
   - Изберете база данни "autoparts"
   - Разгледайте създадените колекции и данни

### 8. Отстраняване на проблеми

При проблеми със свързването към MongoDB Atlas:

1. Проверете дали връзката (MONGODB_URI) е правилно форматирана
2. Уверете се, че потребителското име и паролата са правилни
3. Проверете дали IP адресът ви е разрешен в настройките за мрежов достъп
4. Проверете конзолата за конкретни съобщения за грешки

## VI. Заключение

Проектът демонстрира възможностите на MongoDB за съхранение и обработка на данни за магазин за авточасти. Той показва правилно структуриране на данните в документи и колекции, използване на различни типове индекси за оптимизация, изпълнение на разнообразни заявки от прости до сложни агрегационни заявки, както и реализация на механизми за контрол на достъпа до данните.
